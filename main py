import os
import telegram
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import google.generativeai as genai

# Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Railway
TOKEN = os.getenv("TELEGRAM_TOKEN")
API_KEY = os.getenv("GEMINI_API_KEY")
TAG = os.getenv("AMAZON_TAG", "chop07c-20")

# Ø¥Ø¹Ø¯Ø§Ø¯ Gemini Ù…Ø¹ ÙØ­Øµ Ø§Ù„Ù…ÙØªØ§Ø­
if API_KEY:
    try:
        genai.configure(api_key=API_KEY)
        model = genai.GenerativeModel('gemini-1.5-flash')
    except Exception as e:
        print(f"Error configuring Gemini: {e}")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸ›ï¸ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ø³Ù…Ù‡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø£Ù…Ø§Ø²ÙˆÙ†.")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    status_msg = await update.message.reply_text("ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...")
    
    try:
        product_name = ""
        
        # Ø¥Ø°Ø§ Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙˆØ±Ø©
        if update.message.photo:
            file = await update.message.photo[-1].get_file()
            img_bytes = await file.download_as_bytearray()
            response = model.generate_content([
                "Identify this product. Respond with ONLY the commercial name.",
                {"mime_type": "image/jpeg", "data": bytes(img_bytes)}
            ])
            product_name = response.text.strip()
        
        # Ø¥Ø°Ø§ Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ØµØ§Ù‹
        elif update.message.text:
            product_name = update.message.text

        if product_name:
            # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø£Ù…Ø§Ø²ÙˆÙ† Ø§Ù„ØµØ­ÙŠØ­ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±)
            amazon_url = f"https://www.amazon.com/s?k={product_name.replace(' ', '+')}&tag={TAG}"
            kb = [[InlineKeyboardButton("ğŸ›’ Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø¢Ù† Ù…Ù† Ø£Ù…Ø§Ø²ÙˆÙ†", url=amazon_url)]]
            
            await update.message.reply_text(
                f"âœ… Ø§Ù„Ù…Ù†ØªØ¬: **{product_name}**",
                reply_markup=InlineKeyboardMarkup(kb),
                parse_mode='Markdown'
            )
        
        await status_msg.delete()

    except Exception as e:
        print(f"Error: {e}")
        await status_msg.edit_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« GEMINI_API_KEY ÙÙŠ Railway.")

if __name__ == '__main__':
    if not TOKEN:
        print("TELEGRAM_TOKEN is missing!")
    else:
        app = Application.builder().token(TOKEN).build()
        app.add_handler(CommandHandler("start", start))
        app.add_handler(MessageHandler(filters.PHOTO | filters.TEXT & ~filters.COMMAND, handle_message))
        app.run_polling(drop_pending_updates=True)
